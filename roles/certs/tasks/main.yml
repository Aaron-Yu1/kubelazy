---
# tasks file for certs
- name: get certs directory info
  stat: 
    path: certs/
  register: d
- name: Creste a dir for certs
  file:
    path: certs
    state: directory
  when: "d.stat.isreg is not defined"
- name: get ca infor
  stat:
    path: certs/ca.crt
  register: p
- name: create ca key
  shell: openssl genrsa -out certs/ca.key 2048
  when: "p.stat.isreg is not defined"
- name: create ca cert
  shell: openssl req -x509 -new -nodes \
                 -key certs/ca.key \
                 -subj "/CN={{ domian_name }}" \
                 -days {{ root_ca_expire }} -out certs/ca.crt
  when: "p.stat.isreg is not defined"
- name: Check ssl file state
  stat:
    path: certs/etcd_ssl.cnf
  register: S
- name: copy ssl file
  template:
    src: etcd_ssl.cnf.j2
    dest: certs/etcd_ssl.cnf
  when: "S.stat.isreg is not defined"
- name: Get etcd server cert infor
  stat:
    path: certs/etcd_server.crt
  register: ES
- name: Create etcd server key
  shell: openssl genrsa -out certs/etcd_server.key 2048
  when: "ES.stat.isreg is not defined"
- name: Get csr file
  shell:  openssl req -new -key certs/etcd_server.key \
                  -config certs/etcd_ssl.cnf \
                  -subj "/CN=etcd-server" \
                  -out certs/etcd_server.csr
  when: "ES.stat.isreg is not defined"
- name: Create etcd server cert
  shell: openssl x509 -req -in certs/etcd_server.csr \
                 -CA certs/ca.crt -CAkey certs/ca.key \
                 -CAcreateserial -days {{ expire_day }} \
                 -extensions v3_req -extfile certs/etcd_ssl.cnf \
                 -out certs/etcd_server.crt
  when: "ES.stat.isreg is not defined"
- name: Get etcd client cert infor
  stat:
    path: certs/etcd_client.crt
  register: EC
- name: Create etcd client key
  shell: openssl genrsa -out certs/etcd_client.key 2048
  when: "EC.stat.isreg is not defined"
- name: Get csr file
  shell: openssl req -new -key certs/etcd_client.key \
                 -config certs/etcd_ssl.cnf \
                 -subj "/CN=etcd-client" \
                 -out certs/etcd_client.csr
  when: "EC.stat.isreg is not defined"
- name: Create etcd client cert
  shell: openssl x509 -req -in certs/etcd_client.csr \
                 -CA certs/ca.crt -CAkey certs/ca.key \
                 -CAcreateserial -days {{ expire_day }} \
                 -extensions v3_req -extfile certs/etcd_ssl.cnf \
                 -out certs/etcd_client.crt
  when: "EC.stat.isreg is not defined"
- name: Get API Server certificate state
  stat: 
    path: certs/apiserver.crt
  register: AS
- name: Copy ssl file of APIServer
  template:
    src: master_ssl.cnf.j2
    dest: certs/master_ssl.cnf
  when: "AS.stat.isreg is not defined"
- name: Creste API Server key
  shell: openssl genrsa -out certs/apiserver.key 2048
  when: "AS.stat.isreg is not defined"
- name: Create csr file
  shell: openssl req -new -key certs/apiserver.key \
                 -config certs/master_ssl.cnf \
                 -subj "/CN=master" \
                 -out certs/apiserver.csr
  when: "AS.stat.isreg is not defined"
- name: Create certificate file
  shell: openssl x509 -req -in certs/apiserver.csr \
                 -CA certs/ca.crt -CAkey certs/ca.key \
                 -CAcreateserial -days {{ expire_day }} \
                 -extensions v3_req -extfile certs/master_ssl.cnf \
                 -out certs/apiserver.crt
  when: "AS.stat.isreg is not defined"
- name: Get API client certificate state
  stat: 
    path: certs/client.crt
  register: AC
- name: Create API client key
  shell: openssl genrsa -out certs/client.key 2048
  when: "AC.stat.isreg is not defined"
- name: Create csr file
  shell: openssl req -new -key certs/client.key \
                 -subj "/CN=kubernetes.default.svc" \
                 -out certs/client.csr
  when: "AC.stat.isreg is not defined"
- name: Create API Client certificate
  shell: openssl x509 -req -in certs/client.csr \
                 -CA certs/ca.crt -CAkey certs/ca.key -CAcreateserial \
                 -out certs/client.crt -days {{ expire_day }}
  when: "AC.stat.isreg is not defined"
